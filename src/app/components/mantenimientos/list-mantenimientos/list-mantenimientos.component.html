<!-- Modal principal -->
<div class="modal" tabindex="-1" style="display: block" (click)="cerrarModal()">
    <div
        class="modal-dialog modal-xl modal-dialog-scrollable"
        (click)="$event.stopPropagation()"
    >
        <div class="modal-content">
            <!-- Header -->
            <div class="modal-header">
                <h5 class="modal-title">
                    Mantenimientos de {{ equipo.matricula }}
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                    (click)="cerrarModal()"
                >
                    X
                </button>
            </div>

            <!-- Body -->
            <div class="modal-body">
                <!-- Botón para mostrar formulario -->
                <div class="row justify-content-end">
                    <div class="col-auto">
                        <button
                            class="btn btn-dark mb-3"
                            (click)="abrirFormulario(0)"
                        >
                            Agregar mantenimiento
                        </button>
                    </div>
                </div>

                <!-- Lista de mantenimientos -->
                <div>
                    <div>
                        <table
                            mat-table
                            [dataSource]="dataSource"
                            class="mat-elevation-z8 table table-striped table-hover"
                        >
                            <!-- FECHA -->
                            <ng-container matColumnDef="fecha">
                                <th
                                    mat-header-cell
                                    *matHeaderCellDef
                                    class="bg-dark text-white"
                                >
                                    Fecha
                                </th>
                                <td mat-cell *matCellDef="let m">
                                    {{
                                        m.fechaMantenimiento
                                            | date : "dd/MM/yyyy"
                                    }}
                                </td>
                            </ng-container>

                            <!-- DESCRIPCIÓN -->
                            <ng-container matColumnDef="detalle">
                                <th
                                    mat-header-cell
                                    *matHeaderCellDef
                                    class="bg-dark text-white"
                                >
                                    Descripción
                                </th>
                                <td mat-cell *matCellDef="let m">
                                    {{ m.descripcion }}
                                </td>
                            </ng-container>

                            <!-- CANTIDAD -->
                            <ng-container matColumnDef="cantidad">
                                <th
                                    mat-header-cell
                                    *matHeaderCellDef
                                    class="bg-dark text-white"
                                >
                                    Uso
                                </th>
                                <td mat-cell *matCellDef="let m">
                                    {{ m.cantidadUnidadMedida }}
                                    {{
                                        m.unidadMedida === "HT"
                                            ? " Horas"
                                            : " Km"
                                    }}
                                </td>
                            </ng-container>
                            <!-- ES SERVICE -->
                            <ng-container matColumnDef="service">
                                <th
                                    mat-header-cell
                                    *matHeaderCellDef
                                    class="bg-dark text-white"
                                >
                                    ¿Es service?
                                </th>
                                <td mat-cell *matCellDef="let m">
                                    <span
                                        class="badge"
                                        [class.bg-success]="m.esService"
                                        [class.bg-secondary]="!m.esService"
                                    >
                                        {{ m.esService ? "Sí" : "No" }}
                                    </span>
                                </td>
                            </ng-container>

                            <!-- ACCIONES -->
                            <ng-container matColumnDef="acciones">
                                <th
                                    mat-header-cell
                                    *matHeaderCellDef
                                    class="bg-dark text-white text-center"
                                >
                                    Acciones
                                </th>
                                <td
                                    mat-cell
                                    *matCellDef="let m"
                                    class="text-center"
                                >
                                    <button
                                        class="btn btn-dark btn-sm me-2"
                                        (click)="abrirFormulario(m.id ?? 0)"
                                        title="Editar"
                                    >
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button
                                        *ngIf="
                                            authservice.getRol() !=
                                            'ROLE_UNIDAD'
                                        "
                                        class="btn btn-danger btn-sm"
                                        (click)="
                                            eliminarMantenimiento(m.id ?? 0)
                                        "
                                        title="Eliminar"
                                    >
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </ng-container>

                            <!-- FILAS -->
                            <tr
                                mat-header-row
                                *matHeaderRowDef="displayedColumns"
                            ></tr>
                            <tr
                                mat-row
                                *matRowDef="let row; columns: displayedColumns"
                            ></tr>

                            <!-- SIN DATOS -->
                            <tr class="mat-row" *matNoDataRow>
                                <td
                                    class="mat-cell"
                                    [attr.colspan]="displayedColumns.length"
                                >
                                    No hay mantenimientos que coincidan con "{{
                                        filtro
                                    }}"
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                <!-- Spinner de carga -->
                <div class="text-center my-3" *ngIf="isLoading">
                    <div class="spinner-border text-dark" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>

            <!-- Footer opcional -->
            <div class="modal-footer" *ngIf="!mostrarFormulario">
                <button class="btn btn-secondary" (click)="cerrarModal()">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<div *ngIf="mostrarFormulario">
    <mantenimiento-form
        [equipo]="equipo"
        [mantenimiento]="nuevoMantenimiento"
        (cerrarFormulario)="cerrarFormulario()"
        (mantenimientoAgregado)="recargarLista()"
    ></mantenimiento-form>
</div>
