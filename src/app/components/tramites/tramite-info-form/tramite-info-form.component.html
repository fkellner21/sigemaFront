<div class="modal" tabindex="-1" style="display: block">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h5 class="modal-title w-100 text-center">
                    {{ tramite.id ? "Actualizar trámite" : "Agregar trámite" }}
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                    (click)="onCancel()"
                ></button>
            </div>

            <div class="modal-body">
                <div *ngIf="isLoading" class="form text-center">
                    <p><strong> Cargando... </strong></p>
                    <div class="spinner-border text-dark" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>

                <form
                    #tramiteForm="ngForm"
                    (ngSubmit)="onSubmit()"
                    class="row"
                    *ngIf="!isLoading"
                >
                    <div class="col-xl-4 pe-3 border-end">
                        <!-- Tipo de trámite -->
                        <div class="col-lg-12">
                            <p>Tipo de Trámite</p>
                            <select
                                class="form-control my-2"
                                name="tipoTramite"
                                [(ngModel)]="tramite.tipoTramite"
                                disabled
                            >
                                <option [ngValue]="null" disabled>
                                    Seleccione un tipo...
                                </option>
                                <option
                                    *ngFor="let tipo of tipoTramiteOptions"
                                    [ngValue]="tipo.key"
                                >
                                    {{ tipo.label }}
                                </option>
                            </select>
                        </div>
                        <div class="row">
                            <!-- Estado -->
                            <div class="col-lg-6">
                                <p>Estado</p>
                                <select
                                    class="form-control my-2"
                                    name="estado"
                                    [(ngModel)]="tramite.estado"
                                    required
                                    [disabled]="tramite.id == null"
                                >
                                    <option [ngValue]="null" disabled>
                                        Seleccione un estado...
                                    </option>
                                    <option
                                        *ngFor="let estado of estadoOptions"
                                        [ngValue]="estado.key"
                                    >
                                        {{ estado.label }}
                                    </option>
                                </select>
                            </div>

                            <!-- Fecha inicio -->
                            <div class="col-lg-6">
                                <p>Fecha de inicio</p>
                                <input
                                    type="date"
                                    class="form-control my-2"
                                    name="fechaInicio"
                                    [value]="
                                        tramite.fechaInicio
                                            | date : 'yyyy-MM-dd'
                                    "
                                    disabled
                                />
                            </div>
                        </div>
                        <div class="row">
                            <!-- Unidad Origen -->
                            <div class="col-lg-6">
                                <p>Unidad de Origen</p>
                                <select
                                    class="form-control my-2"
                                    name="unidadOrigen"
                                    [(ngModel)]="tramite.idUnidadOrigen"
                                    required
                                    disabled
                                >
                                    <option disabled>
                                        Seleccione una unidad
                                    </option>
                                    <option [ngValue]="0">Todos</option>
                                    <option
                                        *ngFor="let unidad of unidades"
                                        [ngValue]="unidad.id"
                                    >
                                        {{ unidad.nombre }}
                                    </option>
                                </select>
                            </div>

                            <!-- Unidad Destino -->
                            <div class="col-lg-6">
                                <p>Unidad de Destino</p>
                                <select
                                    class="form-control my-2"
                                    name="unidadDestino"
                                    [(ngModel)]="tramite.idUnidadDestino"
                                    required
                                >
                                    <option disabled>
                                        Seleccione una unidad
                                    </option>
                                    <option [ngValue]="0">Todos</option>
                                    <option
                                        *ngFor="let unidad of unidades"
                                        [ngValue]="unidad.id"
                                    >
                                        {{ unidad.nombre }}
                                    </option>
                                </select>
                            </div>
                        </div>
                        <!-- Texto -->
                        <div class="col-12">
                            <p>Texto</p>
                            <textarea
                                class="form-control my-2"
                                [(ngModel)]="tramite.texto"
                                name="texto"
                                rows="3"
                                placeholder="Ingrese información adicional..."
                            ></textarea>
                        </div>
                    </div>

                    <div class="col-xl-8 ps-3">
                        <!-- Mitad derecha: espacio para agregar cosas -->
                        <p><strong>Actuaciones sobre el tramite</strong></p>
                        <div class="mb-3">
                            <label for="nuevaActuacion" class="form-label"
                                >Nueva actuación</label
                            >
                            <textarea
                                id="nuevaActuacion"
                                [(ngModel)]="nuevaActuacion"
                                name="nuevaActuacion"
                                class="form-control"
                                rows="5"
                                placeholder="Escriba una nueva actuación..."
                            ></textarea>
                        </div>

                        <div class="text-end">
                            <button
                                type="button"
                                class="btn btn-dark"
                                (click)="guardarActuacion()"
                                [disabled]="
                                    !nuevaActuacion.trim() ||
                                    (tramite.id ?? 0) == 0
                                "
                            >
                                Guardar actuación
                            </button>
                        </div>

                        <!-- HISTORIAL DE ACTUACIONES -->
                        <div class="mb-3">
                            <p><strong>Historial de actuaciones</strong></p>
                            <div
                                class="border rounded p-2"
                                style="
                                    max-height: 300px;
                                    overflow-y: auto;
                                    background-color: #f9f9f9;
                                "
                            >
                                <div
                                    *ngFor="
                                        let actuacion of tramite.actuaciones
                                    "
                                    class="mb-3"
                                >
                                    <div
                                        class="d-flex justify-content-between align-items-center mb-1"
                                    >
                                        <strong>
                                            {{
                                                (actuacion.usuario?.grado
                                                    ?.nombre || " ") +
                                                    " " +
                                                    (actuacion.usuario
                                                        ?.nombreCompleto ||
                                                        "Sin solicitante")
                                            }}</strong
                                        >
                                        <span class="text-muted">
                                            {{
                                                actuacion.fecha
                                                    | date : "dd/MM/yyyy HH:mm"
                                            }}
                                        </span>
                                    </div>
                                    <textarea
                                        #txtDesc
                                        class="form-control"
                                        [value]="actuacion.descripcion"
                                        rows="3"
                                        readonly
                                        style="
                                            resize: none;
                                            background-color: #f1f1f1;
                                            overflow: hidden;
                                        "
                                        (input)="autoGrow(txtDesc)"
                                    ></textarea>
                                </div>

                                <div
                                    *ngIf="
                                        !tramite.actuaciones ||
                                        tramite.actuaciones.length === 0
                                    "
                                    class="text-muted"
                                >
                                    No hay actuaciones registradas.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- BOTONES -->
                    <div class="col-lg-12">
                        <div class="row justify-content-between mt-3">
                            <div class="col-lg-4">
                                <button
                                    type="submit"
                                    class="btn btn-primary w-100"
                                    [disabled]="tramiteForm.invalid"
                                >
                                    {{ tramite.id ? "Actualizar" : "Guardar" }}
                                </button>
                            </div>
                            <div class="col-lg-2">
                                <button
                                    type="button"
                                    class="btn btn-secondary w-100"
                                    (click)="onCancel()"
                                >
                                    Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
