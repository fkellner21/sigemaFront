<div class="titulo text-center my-1">Listado de tramites</div>

<div class="row me-0">
    <div class="row pe-0 justify-content-between align-items-center">
        <div class="col-4">
            <mat-form-field class="w-100">
                <mat-label>Buscar</mat-label>
                <input matInput (keyup)="applyFilter($event)" #input />
            </mat-form-field>
        </div>
        <div class="col-4 pe-0 text-end">
            <button (click)="abrirFormularioTramite()" class="btn btn-dark">
                Nuevo Tramite
            </button>
        </div>
    </div>
    <div>
        <table
            mat-table
            [dataSource]="dataSource"
            class="mat-elevation-z8 table table-striped table-hover"
        >
            <ng-container matColumnDef="Origen">
                <th
                    mat-header-cell
                    *matHeaderCellDef
                    class="bg-dark text-white"
                >
                    Origen
                </th>
                <td mat-cell *matCellDef="let element">
                    {{ element.unidadOrigen?.nombre || "" }}
                </td>
            </ng-container>

            <ng-container matColumnDef="Destino">
                <th
                    mat-header-cell
                    *matHeaderCellDef
                    class="bg-dark text-white"
                >
                    Destino
                </th>
                <td mat-cell *matCellDef="let element">
                    {{ element.unidadDestino?.nombre || "" }}
                </td>
            </ng-container>

            <ng-container matColumnDef="Fecha">
                <th
                    mat-header-cell
                    *matHeaderCellDef
                    class="bg-dark text-white"
                >
                    Fecha
                </th>
                <td mat-cell *matCellDef="let element">
                    {{
                        element.fecha
                            ? (element.fecha | date : "dd/MM/yyyy")
                            : ""
                    }}
                </td>
            </ng-container>

            <ng-container matColumnDef="Solicitante">
                <th
                    mat-header-cell
                    *matHeaderCellDef
                    class="bg-dark text-white"
                >
                    Solicitante
                </th>
                <td mat-cell *matCellDef="let element">
                    {{
                        element.usuario?.grado +
                            " " +
                            element.usuario?.nombreCompleto || "Sin solicitante"
                    }}
                </td>
            </ng-container>

            <ng-container matColumnDef="Tipo">
                <th
                    mat-header-cell
                    *matHeaderCellDef
                    class="bg-dark text-white"
                >
                    Tipo
                </th>
                <td mat-cell *matCellDef="let element">
                    {{ getTipoLabel(element.tipoTramite) }}
                </td>
            </ng-container>

            <ng-container matColumnDef="Estado">
                <th
                    mat-header-cell
                    *matHeaderCellDef
                    class="bg-dark text-white"
                >
                    Estado
                </th>
                <td mat-cell *matCellDef="let element">
                    {{ getEstadoLabel(element.estado) }}
                </td>
            </ng-container>

            <!-- Columna Acciones -->
            <ng-container matColumnDef="acciones">
                <th
                    mat-header-cell
                    *matHeaderCellDef
                    class="bg-dark text-white text-center"
                >
                    Acciones
                </th>
                <td mat-cell *matCellDef="let element" class="text-center">
                    <button
                        *ngIf="element.estado != 'Iniciado'"
                        class="btn btn-dark btn-sm me-2"
                        (click)="abrirFormularioTramite(element)"
                        title="Editar tramite"
                    >
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button
                        *ngIf="
                            authservice.getRol() == 'ROLE_ADMINISTRADOR' &&
                            element.estado == 'Resuelto'
                        "
                        class="btn btn-danger btn-sm"
                        (click)="eliminarTramite(element.id)"
                        title="Eliminar tramite"
                    >
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

            <tr class="mat-row" *matNoDataRow>
                <td class="mat-cell" [attr.colspan]="displayedColumns.length">
                    No existen datos para la consulta "{{ input.value }}"
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="text-center my-3" *ngIf="isLoading">
    <div class="spinner-border text-dark" role="status">
        <span class="visually-hidden">Cargando...</span>
    </div>
</div>

<tramite-equipo-form
    *ngIf="mostrarFormularioEquipo"
    [tramite]="tramiteSeleccionado"
></tramite-equipo-form>
<tramite-repuesto-form
    *ngIf="mostrarFormularioRepuesto"
    [tramite]="tramiteSeleccionado"
></tramite-repuesto-form>
<tramite-usuario-form
    *ngIf="mostrarFormularioUsuario"
    [tramite]="tramiteSeleccionado"
></tramite-usuario-form>
<tramite-info-form
    *ngIf="mostrarFormularioInfo"
    [tramite]="tramiteSeleccionado"
    [unidades]="unidades"
    (cancelEventEmiter)="cerrarFormularios()"
></tramite-info-form>
